<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

    <script>
        // Configurações do provedor de autenticação OAuth 2.0
        const clientId = '8cf6d21d-6371-4da7-9eca-a4aac477492d';
        const authorizationEndpoint = 'https://login.microsoftonline.com/3d43e001-1b92-4697-b855-1d8ca369b21e/oauth2/v2.0/authorize';
        const tokenEndpoint = 'https://login.microsoftonline.com/3d43e001-1b92-4697-b855-1d8ca369b21e/oauth2/v2.0/token';
        const redirectUri = 'https://main.d1h8os4syq8ofp.amplifyapp.com/forms.html'; 
        const responseType = 'code';
        const scope = 'openid email profile';

        // Função para redirecionar ao provedor
        function redirectToAuth() {
            const authorizationUrl = `${authorizationEndpoint}?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=${responseType}&scope=${scope}`;
            window.location.href = authorizationUrl;
        }

        // Função para trocar o código pelo token de acesso
        async function getAccessToken(authCode) {
            const response = await fetch(tokenEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'client_id': clientId,
                    'grant_type': 'authorization_code',
                    'code': authCode,
                    'redirect_uri': redirectUri,
                    'scope': scope
                })
            });

            const data = await response.json();
            return data.access_token;
        }

        // Função para obter o email do usuário usando o token de acesso
        async function getUserEmail(accessToken) {
            const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            const data = await response.json();
            return data.mail || data.userPrincipalName;
        }

        // Verifica se há um código de autorização na URL
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');

        if (authCode) {
            // Troca o código pelo token de acesso e obtém o email
            getAccessToken(authCode).then(accessToken => {
                return getUserEmail(accessToken);
            }).then(email => {
                console.log('User email:', email);
                // Aqui você pode usar o email conforme necessário
            }).catch(error => {
                console.error('Erro ao obter o token de acesso ou o email do usuário:', error);
            });
        } else {
            // Redireciona para a autenticação
            redirectToAuth();
        }
    </script>
</body>
</html>
