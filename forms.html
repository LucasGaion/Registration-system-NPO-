<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulários</title>
  <link rel="stylesheet" href="/public/styles/forms.css">
  <link rel="icon" href="/public/img/logoNPOnovo.png" type="NPO-LOGO"> 
  
</head>

<script>
  function getParameterByName(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
  }

  // Verifica se o código de autorização está presente na URL
  const code = getParameterByName('code');
  if (code) {
      console.log('Authorization Code:', code);
  } else {
      console.log('No authorization code found.');
  }
</script>


<body>
  <div class="container mt-5">
    <form id="myForm">
      <img src="/public/img/logoNPOnovo.png" alt="Logo NPO" id="logo">

      <div class="form-group">

        <div class="email-warning">
          Por favor, preencha o email obrigatório
        </div>

        <div class="form-group email-group">
        <input type="text" id="email" name="email" class="form-control" placeholder="Digite o seu e-mail" required>
          <select id="domain" name="domain" class="form-select" required>
            <option value="" disabled selected hidden>Escolha o domínio</option>
            <option value="@nposervices.com">@nposervices.com</option>
            <option value="@external.cnhind.com">@external.cnhind.com</option>
            <option value="@external.ivecogroup.com">@external.ivecogroup.com</option>
            <option value="@reckitt.com">@reckitt.com</option>
            <option value="@rb.com">@rb.com</option>
            <option value="@cnhind.com">@cnhind.com</option>
            <option value="@external.stellantis.com">@external.stellantis.com</option>
            <option value="@equinoxgold.com">@equinoxgold.com</option>
            <option value="@angloamerican.com">@angloamerican.com</option>
            <option value="@ongoing.net">@ongoing.net</option>
            <option value="@ongoingsecurity.com">@ongoingsecurity.com</option>
          </select>
      </div>
          
        <!-- Área de atuação na NPO -->
        <label for="areaAtuacao">Qual sua área de atuação na NPO?</label>
        <select id="areaAtuacao" name="areaAtuacao" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Time - Comercial">Time - Comercial</option>
          <option value="Time - Cloud/Devops">Time - Cloud/Devops</option>
          <option value="Time - Backup">Time - Backup</option>
          <option value="Time - Linux">Time - Linux</option>
          <option value="Time - Windows">Time - Windows</option>
          <option value="Time - Oracle">Time - Oracle</option>
          <option value="Time - Sql">Time - Sql</option>
          <option value="Time - Monitoramento Técnico - VmWare">Time - Monitoramento Técnico - VmWare</option>
          <option value="Time - N2">Time - N2</option>
          <option value="Time - Segurança">Time - Segurança</option>
          <option value="Time - Marketing">Time - Marketing</option>
          <option value="Time - RH">Time - RH</option>
          <option value="Time - Projetos">Time - Projetos</option>
          <option value="Time - Governança">Time - Governança</option>
          <option value="Time - Liderança Técnica">Time - Liderança Técnica</option>
          <option value="Time - Gestão">Time - Gestão</option>
        </select>
      </div>

      <!-- Tempo disponível para estudo -->
      <div class="form-group">
        <label for="tempoEstudo">Quanto tempo você teria disponível por dia para estudar?</label>
        <select id="tempoEstudo" name="tempoEstudo" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="De 30 minutos a 1 hora">De 30 minutos a 1 hora</option>
          <option value="De 1 hora a 2 horas">De 1 hora a 2 horas</option>
          <option value="De 2 a 3 horas">De 2 a 3 horas</option>
          <option value="De 3 a 4 horas">De 3 a 4 horas</option>
          <option value="4 horas ou mais">4 horas ou mais</option>
        </select>
      </div>

      <!-- Nível de familiaridade com conceitos de cloud e AWS -->
      <div class="form-group">
        <label for="nivelCloud">Qual seu nível de familiaridade com os conceitos de cloud e a AWS?</label>
        <select id="nivelCloud" name="nivelCloud" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento prático com a AWS -->
      <div class="form-group">
        <label for="conhecimentoAws">Qual seu nível de conhecimento prático utilizando a console AWS e seus serviços?</label>
        <select id="conhecimentoAws" name="conhecimentoAws" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em redes -->
      <div class="form-group">
        <label for="conhecimentoRedes">Qual seu nível de conhecimento em redes? (roteamento, DNS, protocolos, portas de comunicação, fluxos e etc)</label>
        <select id="conhecimentoRedes" name="conhecimentoRedes" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em armazenamento e backup -->
      <div class="form-group">
        <label for="conhecimentoArmazenamento">Qual seu nível de conhecimento em conceitos de armazenamento e backup?</label>
        <select id="conhecimentoArmazenamento" name="conhecimentoArmazenamento" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em virtualização -->
      <div class="form-group">
        <label for="conhecimentoVirtualizacao">Qual seu nível de conhecimento em virtualização?</label>
        <select id="conhecimentoVirtualizacao" name="conhecimentoVirtualizacao" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em Windows -->
      <div class="form-group">
        <label for="conhecimentoWindows">Qual seu nível de conhecimento em sistema operacional Windows?</label>
        <select id="conhecimentoWindows" name="conhecimentoWindows" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em Linux -->
      <div class="form-group">
        <label for="conhecimentoLinux">Qual seu nível de conhecimento em sistema operacional Linux?</label>
        <select id="conhecimentoLinux" name="conhecimentoLinux" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em segurança -->
      <div class="form-group">
        <label for="conhecimentoSeguranca">Qual seu nível de conhecimento em boas práticas, compliance e segurança?</label>
        <select id="conhecimentoSeguranca" name="conhecimentoSeguranca" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Nível de conhecimento em IAM -->
      <div class="form-group">
        <label for="conhecimentoIAM">Qual seu nível conhecimento em gerenciamento de usuários? (IAM)</label>
        <select id="conhecimentoIAM" name="conhecimentoIAM" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Iniciante">Iniciante</option>
          <option value="Intermediário">Intermediário</option>
          <option value="Avançado">Avançado</option>
        </select>
      </div>

      <!-- Botão de submit -->
      <div class="form-group">
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>

      <!-- Mensagem de Confirmação -->
      <div class="confirmation-forms" id="confirmationForms" style="display: none;">
        <img src="/public/img/checked.png" alt="Ok" id="ok" class="confirmation-icon">
        <span id="confirmationMessage"></span>
      </div>
    </form>
  </div>

<script>
    function validateEmail() {
      var nomeInput = document.getElementById('nome').value.trim();
      var emailPrefixInput = document.getElementById('email').value.trim();
      var domainSelect = document.getElementById('domain');
      var selectedDomain = domainSelect.options[domainSelect.selectedIndex].value;
    
      // Verifica se o e-mail já possui um domínio inserido
      var existingDomainIndex = emailPrefixInput.indexOf('@');
      if (existingDomainIndex !== -1) {
        // Se o e-mail já possui um domínio, remove-o
        emailPrefixInput = emailPrefixInput.substring(0, existingDomainIndex);
      }
    
      var email = emailPrefixInput + selectedDomain;
    
      // Atualiza o valor do campo de e-mail com o e-mail completo (prefixo + domínio)
      document.getElementById('email').value = email;
    
      // Validação do e-mail inserido
      var allowedDomains = [
        '@nposervices.com',
        '@external.cnhind.com',
        '@external.ivecogroup.com',
        '@reckitt.com',
        '@rb.com',
        '@cnhind.com',
        '@external.stellantis.com',
        '@equinoxgold.com',
        '@angloamerican.com',
        '@ongoing.net',
        '@ongoingsecurity.com'
      ];
    
      var domain = email.substring(email.lastIndexOf('@'));
    
      if (!allowedDomains.includes(domain)) {
        document.getElementById('error').style.display = 'block';
        return false; // Impede o envio do formulário se o domínio não estiver na lista permitida
      }
    
      // Se o e-mail estiver correto, prossegue com o envio do formulário
      return true;
    }
    
    // Adiciona o evento de mudança ao elemento com o ID 'domain'
    document.getElementById('domain').addEventListener('change', function() {
      var emailPrefix = document.getElementById('email').value.split('@')[0];
      var selectedDomain = this.value;
    
      // Verifica se o e-mail já possui um domínio inserido
      var existingDomainIndex = emailPrefix.indexOf('@');
      if (existingDomainIndex !== -1) {
        // Se o e-mail já possui um domínio, remove-o
        emailPrefix = emailPrefix.substring(0, existingDomainIndex);
      }
    
      document.getElementById('email').value = emailPrefix + selectedDomain;
    });
</script>

<script type="module">

import { API } from 'aws-amplify';
import _ from './node_modules/lodash/lodash.js'; // Exemplo do caminho onde o lodash foi instalado


// AWS Amplify configuration
const awsconfig = {
  aws_project_region: "us-east-1",
  aws_appsync_graphqlEndpoint: "https://cahg6u6ll5g6howq4n4bdrbvni.appsync-api.us-east-1.amazonaws.com/graphql",
  aws_appsync_region: "us-east-1",
  aws_appsync_authenticationType: "API_KEY",
  aws_appsync_apiKey: "da2-cvkka4f4efb5nj7gqvl4qiykfq"
};
API.configure(awsconfig);

console.log("AWS Config:", awsconfig);

// Function to get the authorization code from URL
function getParameterByName(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Function to submit form data to GraphQL API
async function submitFormData(formData) {
  console.log("Submitting form data:", formData);

  try {
    const graphqlQuery = `
      mutation CreateForms($input: CreateFormsInput!) {
        createForms(input: $input) {
          id
          email
          areaAtuacao
          tempoEstudo
          nivelCloud
          conhecimentoAws
          conhecimentoRedes
          conhecimentoArmazenamento
          conhecimentoVirtualizacao
          conhecimentoWindows
          conhecimentoLinux
          conhecimentoSeguranca
          conhecimentoIAM
          authorizationCode
        }
      }
    `;

    const response = await API.graphql({
      query: graphqlQuery,
      variables: { input: formData }
    });

    console.log("GraphQL Response:", response);
    return response.data.createForms; // Returns the created form data
  } catch (error) {
    console.error('Error submitting the form:', error);
    throw error; // Throw the error for further handling if needed
  }
}

// Add listener for form submit event
document.getElementById('myForm').addEventListener('submit', function(event) {
  event.preventDefault(); // Prevent default form submission

  const code = getParameterByName('code');
  if (!code) {
    console.error('No authorization code found.');
    document.getElementById('confirmationMessage').innerText = 'Erro: Código de autorização não encontrado.';
    document.getElementById('confirmationForms').style.display = 'block'; // Display error message to user
    return;
  }

  const formData = {
    email: document.getElementById('email').value,
    areaAtuacao: document.getElementById('areaAtuacao').value,
    tempoEstudo: document.getElementById('tempoEstudo').value,
    nivelCloud: document.getElementById('nivelCloud').value,
    conhecimentoAws: document.getElementById('conhecimentoAws').value,
    conhecimentoRedes: document.getElementById('conhecimentoRedes').value,
    conhecimentoArmazenamento: document.getElementById('conhecimentoArmazenamento').value,
    conhecimentoVirtualizacao: document.getElementById('conhecimentoVirtualizacao').value,
    conhecimentoWindows: document.getElementById('conhecimentoWindows').value,
    conhecimentoLinux: document.getElementById('conhecimentoLinux').value,
    conhecimentoSeguranca: document.getElementById('conhecimentoSeguranca').value,
    conhecimentoIAM: document.getElementById('conhecimentoIAM').value,
    authorizationCode: code
  };

  console.log("Form data collected:", formData);

  submitFormData(formData)
    .then(result => {
      console.log('Formulário enviado com sucesso!', result);
  window.location.href = `user.html?email=${document.getElementById('email').value}&authorizationCode=${code}`;
    })
    .catch(error => {
      console.error('Erro ao enviar o formulário:', error);
      document.getElementById('confirmationMessage').innerText = 'Erro ao enviar o formulário.';
      document.getElementById('confirmationForms').style.display = 'block'; // Display error message to user
    });
});

</script>
  
  
</body>
</html>
